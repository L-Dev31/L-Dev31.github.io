import puppeteer from 'puppeteer';

export class GoogleMapsScraper {
  constructor(options = {}) {
    this.browser = null;
    this.page = null;
    this.options = {
      headless: true, // Mode invisible
      timeout: options.timeout || 60000,
      maxRetries: options.maxRetries || 3,
      ...options
    };
  }

  async init() {
    try {
      console.log('üöÄ Initializing browser...');
      
      this.browser = await puppeteer.launch({
        headless: true,
        args: [
          '--no-sandbox',
          '--disable-setuid-sandbox',
          '--disable-dev-shm-usage',
          '--disable-web-security',
          '--disable-features=VizDisplayCompositor',
          '--disable-blink-features=AutomationControlled',
          '--disable-extensions',
          '--no-first-run',
          '--disable-default-apps',
          '--disable-infobars',
          '--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
        ],
        defaultViewport: { width: 1366, height: 768 },
        ignoreDefaultArgs: ['--enable-automation']
      });
      
      this.page = await this.browser.newPage();
      
      // Anti-d√©tection avanc√©
      await this.page.evaluateOnNewDocument(() => {
        Object.defineProperty(navigator, 'webdriver', { get: () => undefined });
        window.chrome = { runtime: {} };
        Object.defineProperty(navigator, 'plugins', {
          get: () => [1, 2, 3, 4, 5]
        });
        Object.defineProperty(navigator, 'languages', {
          get: () => ['fr-FR', 'fr', 'en-US', 'en']
        });
      });

      await this.page.setExtraHTTPHeaders({
        'Accept-Language': 'fr-FR,fr;q=0.9,en;q=0.8',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8',
        'Upgrade-Insecure-Requests': '1',
        'Sec-Fetch-Site': 'none',
        'Sec-Fetch-Mode': 'navigate',
        'Sec-Fetch-User': '?1',
        'Sec-Fetch-Dest': 'document'
      });

      // D√©finir des cookies Google pour √©viter la page de consentement
      const googleCookies = [
        {
          name: 'CONSENT',
          value: 'PENDING+987',
          domain: '.google.com',
          path: '/',
          httpOnly: false,
          secure: true
        },
        {
          name: 'SOCS',
          value: 'CAISHAgBEhJnd3NfMjAyMzEyMDQtMF9SQzIaAmZyIAEaBgiA_dGpBg',
          domain: '.google.com',
          path: '/',
          httpOnly: false,
          secure: true
        }
      ];

      try {
        await this.page.setCookie(...googleCookies);
        console.log('üç™ Google cookies set to bypass consent');
      } catch (e) {
        console.log('‚ö†Ô∏è Could not set all cookies:', e.message);
      }

      console.log('‚úÖ Browser initialized successfully');
    } catch (error) {
      console.error('‚ùå Failed to initialize browser:', error);
      throw new Error(`Browser initialization failed: ${error.message}`);
    }
  }

  async close() {
    if (this.browser) {
      await this.browser.close();
    }
  }

  async randomDelay(min = 1000, max = 3000) {
    const delay = Math.random() * (max - min) + min;
    return new Promise(resolve => setTimeout(resolve, delay));
  }

  async scrapeBusinesses(keyword, city, maxResults = 20, progressCallback = null, radius = null) {
    if (!this.browser || !this.page) {
      await this.init();
    }

    const searchQuery = `${keyword} ${city}`;
    const searchUrl = `https://www.google.com/maps/search/${encodeURIComponent(searchQuery)}`;
    
    let attempts = 0;
    
    while (attempts < this.options.maxRetries) {
      try {
        console.log(`üîç Searching: ${searchQuery} (attempt ${attempts + 1}/${this.options.maxRetries})`);
        
        if (progressCallback) progressCallback(10);
        
        // Navigation vers Google Maps
        await this.randomDelay(1000, 3000);
        await this.page.goto(searchUrl, { 
          waitUntil: 'networkidle0', 
          timeout: this.options.timeout 
        });

        console.log('‚è≥ Waiting for page to load...');
        await this.randomDelay(3000, 5000);

        // G√©rer les cookies et la page de consentement Google
        try {
          const currentUrl = this.page.url();
          console.log('üìç Current URL:', currentUrl);
          
          // V√©rifier si on est sur la page de consentement Google
          if (currentUrl.includes('consent.google.com') || await this.page.$('form[action*="consent"]')) {
            console.log('üç™ Detected Google consent page, handling...');
            
            const consentButtons = [
              'button[aria-label*="Accept"]',
              'button[aria-label*="Accepter"]',
              'button:contains("Accept all")',
              'button:contains("Tout accepter")',
              'button[data-ved]', // Bouton Google g√©n√©rique
              'form[action*="consent"] button[type="submit"]',
              '#L2AGLb',
              'button[jsname="b3VHJd"]', // Bouton "Tout accepter" Google
              'button[jsname="tHlp8d"]'  // Bouton "Tout refuser" Google
            ];

            let consentHandled = false;
            for (const selector of consentButtons) {
              try {
                const elements = await this.page.$$(selector);
                if (elements.length > 0) {
                  console.log(`üîò Found consent button: ${selector}`);
                  await elements[0].click();
                  console.log('‚úÖ Consent button clicked');
                  await this.randomDelay(3000, 5000);
                  consentHandled = true;
                  break;
                }
              } catch (e) {
                continue;
              }
            }
            
            // Si les boutons ne fonctionnent pas, essayer de naviguer directement
            if (!consentHandled) {
              console.log('üîÑ Trying direct navigation to bypass consent...');
              await this.page.goto(searchUrl.replace(/\s/g, '+'), { 
                waitUntil: 'networkidle0', 
                timeout: this.options.timeout 
              });
              await this.randomDelay(3000, 5000);
            }
          }

          // G√©rer d'autres types de banni√®res de cookies
          const otherCookieButtons = [
            'button[aria-label*="Accept"]',
            'button[aria-label*="Accepter"]', 
            'button:has-text("Accept all")',
            'button:has-text("Tout accepter")',
            '#L2AGLb',
            '.VfPpkd-LgbsSe[aria-label*="Accept"]'
          ];

          for (const selector of otherCookieButtons) {
            try {
              const element = await this.page.$(selector);
              if (element) {
                await element.click();
                console.log('‚úÖ Additional cookies accepted');
                await this.randomDelay(2000, 3000);
                break;
              }
            } catch (e) {
              continue;
            }
          }
        } catch (e) {
          console.log('‚ÑπÔ∏è Cookie handling completed with minor issues');
        }

        if (progressCallback) progressCallback(30);

        // Attendre les r√©sultats - s√©lecteurs mis √† jour pour 2025
        console.log('üîç Looking for search results...');
        
        let resultsFound = false;
        const resultWaitSelectors = [
          // Nouveaux s√©lecteurs Google Maps 2025
          '[data-result-index]',
          '[role="feed"] [role="article"]',
          '[data-value="Directions"]',
          '.Nv2PK',
          '.hfpxzc',
          '[jsaction*="pane.card.click"]',
          '.m6QErb',
          '[data-cid]',
          // Anciens s√©lecteurs de fallback
          'div[role="main"] [jsaction*="pane.card.click"]',
          'a[data-value="Directions"]',
          '[role="article"]'
        ];

        // Essayer chaque s√©lecteur
        for (const selector of resultWaitSelectors) {
          try {
            await this.page.waitForSelector(selector, { timeout: 10000 });
            const elements = await this.page.$$(selector);
            if (elements.length > 0) {
              console.log(`‚úÖ Found ${elements.length} results with selector: ${selector}`);
              resultsFound = true;
              break;
            }
          } catch (e) {
            console.log(`‚ùå Selector ${selector} failed`);
            continue;
          }
        }

        // Si aucun s√©lecteur n'a fonctionn√©, essayer une approche plus g√©n√©rale
        if (!resultsFound) {
          console.log('üîÑ Trying fallback method - waiting for page content...');
          try {
            // Attendre que la page soit stable (utilisation correcte)
            await new Promise(resolve => setTimeout(resolve, 5000));
            
            // V√©rifier s'il y a du contenu charg√©
            const hasContent = await this.page.evaluate(() => {
              const bodyText = document.body.innerText;
              return bodyText.length > 1000; // Page avec du contenu
            });
            
            if (hasContent) {
              console.log('‚úÖ Page content loaded successfully (fallback method)');
              resultsFound = true;
            }
          } catch (fallbackError) {
            console.log('‚ùå Fallback method failed:', fallbackError.message);
          }
        }

        if (!resultsFound) {
          // Capturer le HTML pour debug
          try {
            const pageContent = await this.page.content();
            console.log('üìÑ Page title:', await this.page.title());
            console.log('üìÑ Page URL:', this.page.url());
            console.log('üìÑ Page content preview:', pageContent.substring(0, 500));
          } catch (debugError) {
            console.log('‚ùå Could not capture debug info');
          }
          throw new Error('No search results found on page');
        }

        if (progressCallback) progressCallback(50);

        // Scroll pour charger plus de r√©sultats
        await this.scrollToLoadResults(maxResults, progressCallback);
        
        // Extraire les donn√©es avec d√©tails complets
        const businesses = await this.extractBusinessData(keyword, city, maxResults, progressCallback);
        
        console.log(`‚úÖ Successfully scraped ${businesses.length} businesses`);
        return businesses;
        
      } catch (error) {
        attempts++;
        console.error(`‚ùå Scraping attempt ${attempts} failed:`, error.message);
        
        if (attempts >= this.options.maxRetries) {
          // Screenshot de debug
          try {
            const debugPath = `debug-screenshot-${Date.now()}.png`;
            await this.page.screenshot({ path: debugPath, fullPage: true });
            console.log(`üì∏ Debug screenshot saved: ${debugPath}`);
          } catch (screenshotError) {
            console.log('‚ùå Could not save debug screenshot');
          }
          
          throw new Error(`Failed after ${this.options.maxRetries} attempts: ${error.message}`);
        }
        
        console.log(`‚è≥ Waiting ${5 + attempts * 2} seconds before retry...`);
        await this.randomDelay((5 + attempts * 2) * 1000, (7 + attempts * 2) * 1000);
        
        // Nouvelle page pour le retry
        try {
          await this.page.close();
          this.page = await this.browser.newPage();
          await this.page.setExtraHTTPHeaders({
            'Accept-Language': 'fr-FR,fr;q=0.9,en;q=0.8',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8'
          });
        } catch (e) {
          console.warn('Could not reset page for retry');
        }
      }
    }
  }

  async scrollToLoadResults(maxResults, progressCallback = null) {
    console.log('üìú Scrolling to load more results...');
    
    try {
      let scrollAttempts = 0;
      const maxScrollAttempts = Math.min(10, Math.ceil(maxResults / 3));

      while (scrollAttempts < maxScrollAttempts) {
        // Scroll dans le panneau lat√©ral Google Maps
        await this.page.evaluate(() => {
          // Trouver le conteneur de r√©sultats
          const containers = [
            document.querySelector('div[role="main"]'),
            document.querySelector('.m6QErb'),
            document.querySelector('[aria-label*="Results for"]'),
            document.querySelector('.Nv2PK'),
            document.querySelector('#pane')
          ];
          
          let scrolled = false;
          for (const container of containers) {
            if (container) {
              container.scrollTop = container.scrollHeight;
              scrolled = true;
              break;
            }
          }
          
          // Fallback: scroll global
          if (!scrolled) {
            window.scrollTo(0, document.body.scrollHeight);
          }
        });

        await this.randomDelay(2000, 4000);
        
        // V√©rifier combien de r√©sultats on a maintenant
        const currentCount = await this.page.evaluate(() => {
          const selectors = [
            'div[role="main"] [jsaction*="pane.card.click"]',
            'a[data-value="Directions"]',
            '[role="article"]',
            '.hfpxzc'
          ];
          
          for (const selector of selectors) {
            const elements = document.querySelectorAll(selector);
            if (elements.length > 0) {
              return elements.length;
            }
          }
          return 0;
        });
        
        console.log(`üìä Currently loaded: ${currentCount} results`);
        
        if (progressCallback) {
          const progress = Math.min(80, 50 + (currentCount / maxResults) * 30);
          progressCallback(progress);
        }
        
        if (currentCount >= maxResults) {
          console.log(`‚úÖ Loaded enough results: ${currentCount}`);
          break;
        }
        
        scrollAttempts++;
      }

    } catch (error) {
      console.warn('‚ö†Ô∏è Scrolling error:', error.message);
    }
  }

  async extractBusinessData(keyword, city, maxResults, progressCallback = null) {
    console.log('üìã Extracting business data...');
    
    try {
      await this.randomDelay(2000, 3000);
      
      // D'abord, obtenir la liste des businesses visibles
      const businessLinks = await this.page.evaluate((maxResults) => {
        const results = [];
        
        // S√©lecteurs pour les √©l√©ments business Google Maps 2024
        const businessSelectors = [
          '.hfpxzc',
          'div[role="main"] [jsaction*="pane.card.click"]',
          'a[data-value="Directions"]',
          '[role="article"]',
          'div[data-result-index]'
        ];
        
        let businessElements = [];
        for (const selector of businessSelectors) {
          businessElements = document.querySelectorAll(selector);
          if (businessElements.length > 0) {
            console.log(`Using selector: ${selector} (${businessElements.length} found)`);
            break;
          }
        }
        
        // Extraire les noms et URLs de base
        for (let i = 0; i < Math.min(businessElements.length, maxResults); i++) {
          const element = businessElements[i];
          
          try {
            let name = null;
            let url = null;
            
            // Extraction du nom
            const nameSelectors = [
              '.qBF1Pd.fontHeadlineSmall', // S√©lecteur principal Google Maps 2025
              '.fontHeadlineSmall',
              '.fontHeadlineMedium', 
              '.qBF1Pd',
              '.DUwDvf',
              'h3',
              '.place-name',
              '[data-value*="title"]',
              'span[role="img"] + div div',
              'a[href*="place"] span'
            ];
            
            for (const selector of nameSelectors) {
              const nameEl = element.querySelector(selector);
              if (nameEl && nameEl.textContent.trim()) {
                name = nameEl.textContent.trim();
                console.log(`‚úÖ Found name "${name}" with selector: ${selector}`);
                break;
              }
            }
            
            // Si aucun nom n'est trouv√©, essayer d'extraire depuis le contenu g√©n√©ral
            if (!name) {
              const allText = element.textContent || '';
              const lines = allText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
              // Prendre la premi√®re ligne qui ressemble √† un nom de business (pas trop courte, pas de chiffres au d√©but)
              for (const line of lines) {
                if (line.length > 2 && line.length < 100 && !/^\d/.test(line) && 
                    !line.includes('√©toiles') && !line.includes('‚Ç¨') && !line.includes('km')) {
                  name = line;
                  console.log(`‚úÖ Found name from text: "${name}"`);
                  break;
                }
              }
            }
            
            // URL depuis href ou data-attribute
            if (element.href) {
              url = element.href;
            } else {
              const linkEl = element.querySelector('a[href*="maps"]');
              if (linkEl) url = linkEl.href;
            }
            
            // Fallback nom depuis aria-label
            if (!name && element.getAttribute('aria-label')) {
              name = element.getAttribute('aria-label').split(',')[0].trim();
            }
            
            if (name && name.length > 2) {
              results.push({ name, url, elementIndex: i });
            }
            
          } catch (error) {
            console.error(`Error processing business ${i}:`, error);
          }
        }
        
        return results;
      }, maxResults);
      
      console.log(`üìä Found ${businessLinks.length} businesses to process`);
      
      const detailedBusinesses = [];
      
      // Maintenant, cliquer sur chaque business pour obtenir les d√©tails
      for (let i = 0; i < businessLinks.length; i++) {
        const businessInfo = businessLinks[i];
        
        if (progressCallback) {
          const progress = 50 + (i / businessLinks.length) * 45; // 50% √† 95%
          progressCallback(progress);
        }
        
        console.log(`üîç Processing business ${i + 1}/${businessLinks.length}: ${businessInfo.name}`);
        
        try {
          const businessDetails = await this.extractSingleBusinessDetails(businessInfo, keyword, city);
          if (businessDetails) {
            detailedBusinesses.push(businessDetails);
            console.log(`‚úÖ Extracted details for: ${businessDetails.name}`);
            if (businessDetails.email) console.log(`üìß Found email: ${businessDetails.email}`);
            if (businessDetails.phone) console.log(`üìû Found phone: ${businessDetails.phone}`);
            if (businessDetails.website_url) console.log(`üåê Found website: ${businessDetails.website_url}`);
            if (businessDetails.image_url) console.log(`üñºÔ∏è Found image: ${businessDetails.image_url}`);
          }
          
          // D√©lai entre chaque business plus long pour √©viter la d√©tection
          await this.randomDelay(2000, 4000);
          
        } catch (error) {
          console.error(`‚ùå Error processing ${businessInfo.name}:`, error);
          
          // Continuer avec les donn√©es de base si l'extraction d√©taill√©e √©choue
          detailedBusinesses.push({
            search_keyword: keyword,
            city: city,
            name: businessInfo.name,
            category: null,
            rating: null,
            address: null,
            phone: null,
            email: null,
            website_url: businessInfo.url,
            has_website: !!businessInfo.url,
            google_maps_url: businessInfo.url,
            google_maps_id: businessInfo.url ? businessInfo.url.split('/maps/place/')[1]?.split('/')[0] || null : null,
            image_url: null
          });
        }
      }
      
      console.log(`üìä Extracted ${detailedBusinesses.length} businesses with details`);
      
      if (progressCallback) {
        progressCallback(95);
      }
      
      return detailedBusinesses;
      
    } catch (error) {
      console.error('‚ùå Error in extraction:', error);
      throw new Error(`Extraction failed: ${error.message}`);
    }
  }

  async extractSingleBusinessDetails(businessInfo, keyword, city) {
    try {
      // Cliquer sur le business pour ouvrir ses d√©tails
      await this.page.evaluate((elementIndex) => {
        const businessSelectors = [
          '.hfpxzc',
          'div[role="main"] [jsaction*="pane.card.click"]',
          'a[data-value="Directions"]',
          '[role="article"]'
        ];
        
        let businessElements = [];
        for (const selector of businessSelectors) {
          businessElements = document.querySelectorAll(selector);
          if (businessElements.length > elementIndex) {
            businessElements[elementIndex].click();
            break;
          }
        }
      }, businessInfo.elementIndex);
      
      // Attendre que les d√©tails se chargent
      await this.randomDelay(3000, 5000);
      
      // Attendre qu'au moins un √©l√©ment de d√©tail soit visible
      try {
        await this.page.waitForSelector('h1, [data-attrid="title"]', { timeout: 10000 });
      } catch (e) {
        console.log('‚ö†Ô∏è Could not find title element, continuing anyway...');
      }
      
      // Extraire toutes les informations d√©taill√©es
      const businessDetails = await this.page.evaluate((keyword, city, baseName) => {
        const business = {
          search_keyword: keyword,
          city: city,
          name: baseName,
          category: null,
          rating: null,
          address: null,
          phone: null,
          email: null,
          website_url: null,
          has_website: false,
          google_maps_url: window.location.href,
          google_maps_id: null,
          image_url: null
        };
        
        try {
          // Nom (mise √† jour si trouv√© dans les d√©tails)
          const nameSelectors = [
            'h1[data-attrid="title"]',
            'h1.fontHeadlineLarge', 
            'h1.fontHeadlineSmall',
            '.x3AX1-LfntMc-header-title-title',
            'h1',
            '.DUwDvf.fontHeadlineLarge',
            '.qBF1Pd.fontHeadlineSmall',
            '[data-value="title"]',
            '.section-hero-header-title-title',
            'span[jstcache="1006"]' // Google Maps 2025
          ];
          
          for (const selector of nameSelectors) {
            const nameEl = document.querySelector(selector);
            if (nameEl && nameEl.textContent.trim()) {
              business.name = nameEl.textContent.trim();
              console.log(`‚úÖ Updated name to: "${business.name}" using selector: ${selector}`);
              break;
            }
          }
          
          // Si aucun nom n'est trouv√© avec les s√©lecteurs, utiliser le nom de base
          if (business.name === baseName) {
            console.log(`‚ö†Ô∏è Name not updated, keeping original: "${baseName}"`);
          }
          
          // Image principale (recherche √©tendue)
          const imageSelectors = [
            'button[data-value="Photo"] img',
            '.wvLcL img',
            '[data-attrid="kc:/location:media"] img',
            'img[src*="googleusercontent.com"]:not([src*="avatar"])',
            '.section-hero-header-image img',
            '.section-hero img',
            'img[src*="maps.googleapis.com"]',
            '.gallery img',
            '[role="img"] img'
          ];
          
          for (const selector of imageSelectors) {
            const imgEl = document.querySelector(selector);
            if (imgEl && imgEl.src && 
                !imgEl.src.includes('data:image') && 
                !imgEl.src.includes('avatar') && 
                !imgEl.src.includes('icon') &&
                imgEl.src.includes('http') &&
                imgEl.naturalWidth > 50 && imgEl.naturalHeight > 50) {
              business.image_url = imgEl.src;
              break;
            }
          }
          
          // Cat√©gorie
          const categorySelectors = [
            'button[data-value*="search_category"]',
            '.YhemCb',
            '[data-attrid="kc:/collection/knowledge_panels/local_searchresults:business_type"]',
            '.fontBodyMedium[data-attrid*="category"]'
          ];
          
          for (const selector of categorySelectors) {
            const catEl = document.querySelector(selector);
            if (catEl && catEl.textContent.trim() && !catEl.textContent.includes('‚òÖ')) {
              business.category = catEl.textContent.trim();
              break;
            }
          }
          
          // Rating
          const ratingSelectors = [
            '[data-attrid="kc:/collection/knowledge_panels/local_searchresults:star_score"] span',
            '.Aq14fc',
            '.ceNzKf',
            '[aria-label*="star"] span'
          ];
          
          for (const selector of ratingSelectors) {
            const ratingEl = document.querySelector(selector);
            if (ratingEl) {
              const ratingText = ratingEl.textContent || ratingEl.getAttribute('aria-label') || '';
              const ratingMatch = ratingText.match(/(\d+[.,]\d+)/);
              if (ratingMatch) {
                business.rating = parseFloat(ratingMatch[1].replace(',', '.'));
                break;
              }
            }
          }
          
          // Adresse
          const addressSelectors = [
            '[data-attrid="kc:/collection/knowledge_panels/local_searchresults:address"] span',
            'button[data-value="Directions"] .fontBodyMedium',
            '.Io6YTe',
            '[data-attrid*="address"] span'
          ];
          
          for (const selector of addressSelectors) {
            const addrEl = document.querySelector(selector);
            if (addrEl && addrEl.textContent.trim()) {
              business.address = addrEl.textContent.trim();
              break;
            }
          }
          
          // T√©l√©phone (recherche √©tendue)
          const phoneSelectors = [
            'button[data-value^="tel:"]',
            'a[href^="tel:"]',
            'button[aria-label*="phone" i]',
            'button[aria-label*="Call"]',
            'button[aria-label*="t√©l√©phone" i]',
            '[data-attrid*="phone"] span',
            'span[aria-label*="phone" i]'
          ];
          
          for (const selector of phoneSelectors) {
            const phoneEl = document.querySelector(selector);
            if (phoneEl) {
              let phone = phoneEl.getAttribute('data-value') || phoneEl.getAttribute('href') || phoneEl.textContent || phoneEl.getAttribute('aria-label');
              if (phone && phone.includes('tel:')) {
                phone = phone.replace('tel:', '');
              }
              // Extraire le num√©ro de t√©l√©phone du texte
              const phoneMatch = phone?.match(/[\d\+\-\s\(\)\.]{8,}/);
              if (phoneMatch && phoneMatch[0].replace(/[\s\-\(\)\.]/g, '').length >= 8) {
                business.phone = phoneMatch[0].trim();
                break;
              }
            }
          }
          
          // Si pas de t√©l√©phone trouv√©, chercher dans le texte
          if (!business.phone) {
            const textContent = document.body.textContent || document.body.innerText || '';
            const phoneMatches = textContent.match(/(?:\+33|0)[1-9](?:[0-9]{8}|\s[0-9]{2}\s[0-9]{2}\s[0-9]{2}\s[0-9]{2})/g);
            if (phoneMatches && phoneMatches[0]) {
              business.phone = phoneMatches[0].trim();
            }
          }
          
          // Site web (recherche √©tendue)
          const websiteSelectors = [
            'a[data-value^="http"]:not([data-value*="google"]):not([data-value*="maps"])',
            'button[data-value^="http"]:not([data-value*="google"]):not([data-value*="maps"])',
            'a[href^="http"]:not([href*="google"]):not([href*="maps"]):not([href*="facebook"]):not([href*="instagram"]):not([href*="twitter"])',
            '[data-attrid*="website"] a[href^="http"]',
            'button[aria-label*="website" i]',
            'button[aria-label*="site" i]'
          ];
          
          for (const selector of websiteSelectors) {
            const webEl = document.querySelector(selector);
            if (webEl) {
              let website = webEl.getAttribute('data-value') || webEl.getAttribute('href') || webEl.textContent;
              if (website && website.startsWith('http') && 
                  !website.includes('google.com') && 
                  !website.includes('maps') && 
                  !website.includes('facebook') &&
                  !website.includes('instagram') &&
                  !website.includes('twitter')) {
                business.website_url = website;
                business.has_website = true;
                break;
              }
            }
          }
          
          // Email (recherche avanc√©e)
          const emailSelectors = [
            'a[href^="mailto:"]',
            'button[data-value^="mailto:"]',
            '[data-attrid*="email"] a'
          ];
          
          for (const selector of emailSelectors) {
            const emailEl = document.querySelector(selector);
            if (emailEl) {
              let email = emailEl.getAttribute('href') || emailEl.getAttribute('data-value') || emailEl.textContent;
              if (email && email.includes('mailto:')) {
                email = email.replace('mailto:', '');
              }
              if (email && email.includes('@') && email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                business.email = email.trim();
                break;
              }
            }
          }
          
          // Si pas d'email trouv√©, chercher dans tout le texte de la page
          if (!business.email) {
            const textContent = document.body.textContent || document.body.innerText || '';
            const emailMatches = textContent.match(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g);
            if (emailMatches) {
              for (const emailMatch of emailMatches) {
                // Filtrer les emails g√©n√©riques/inutiles
                if (!emailMatch.includes('example') && 
                    !emailMatch.includes('test') && 
                    !emailMatch.includes('google') &&
                    !emailMatch.includes('maps') &&
                    !emailMatch.includes('noreply')) {
                  business.email = emailMatch;
                  break;
                }
              }
            }
          }
          
          // Google Maps ID depuis l'URL
          if (business.google_maps_url) {
            const placeMatch = business.google_maps_url.match(/\/maps\/place\/([^\/\?]+)/);
            if (placeMatch) {
              business.google_maps_id = decodeURIComponent(placeMatch[1]);
            }
          }
          
        } catch (error) {
          console.error('Error extracting business details:', error);
        }
        
        return business;
        
      }, keyword, city, businessInfo.name);
      
      return businessDetails;
      
    } catch (error) {
      console.error('Error in extractSingleBusinessDetails:', error);
      return null;
    }
  }
}
